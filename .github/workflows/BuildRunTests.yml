name: Full Research Project CI

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop

jobs:
  build-test-run:
    runs-on: ubuntu-latest

    env:
      CMAKE_BUILD_TYPE: Release

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          git \
          g++ \
          libopenmpi-dev \
          openmpi-bin \
          libhdf5-dev \
          libboost-all-dev \
          libsundials-dev \
          python3-dev \
          python3-pip

    - name: Install Python Packages
      run: |
        pip3 install numpy matplotlib mpi4py

    - name: Build and Install Kokkos
      run: |
            git clone https://github.com/kokkos/kokkos.git
            mkdir -p kokkos/build
            cd kokkos/build
            cmake .. \
              -DCMAKE_CXX_COMPILER=g++ \
              -DKokkos_ENABLE_OPENMP=ON \
              -DKokkos_ENABLE_SERIAL=ON \
              -DCMAKE_INSTALL_PREFIX=$HOME/kokkos-install
            make -j$(nproc)
            make install

    - name: Build and Install ADIOS2
      run: |
          git clone https://github.com/ornladios/ADIOS2.git
          cd ADIOS2
          git checkout v2.10.1
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_C_COMPILER=mpicc \
            -DCMAKE_CXX_COMPILER=mpicxx \
            -DADIOS2_BUILD_BINDINGS=ON \
            -DADIOS2_USE_Python=ON \
            -DADIOS2_USE_MPI=ON \
            -DCMAKE_INSTALL_PREFIX=$HOME/adios2-install
          make -j$(nproc)
          make install


    - name: Clone Catch2 for Testing
      run: |
        mkdir -p externals
        cd externals
        git clone https://github.com/catchorg/Catch2.git

    - name: Configure CMake Project
      run: |
        mkdir -p build
        cd build
        cmake .. \
          -DADIOS2_DIR=$HOME/adios2-install/lib/cmake/adios2 \
          -DCMAKE_PREFIX_PATH="$HOME/adios2-install;$HOME/kokkos-install" \
          -DCMAKE_BUILD_TYPE=$CMAKE_BUILD_TYPE

    - name: Build Project
      run: |
        cd build
        make -j$(nproc)

    - name: Run Catch2 C++ Tests
      run: |
        cd build
        ctest --output-on-failure

    - name: Run Python Script for Post-processing
      run: |
        export PYTHONPATH=$HOME/adios2-install/lib/python3.10/site-packages:$PYTHONPATH
        python3 your_python_script.py
